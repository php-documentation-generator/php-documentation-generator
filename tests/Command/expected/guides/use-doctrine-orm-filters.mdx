---
slug: use-doctrine-orm-filters
name: Use Doctrine Filters
executable: true
---

<div className="sections">
            <div className="section" id="section-1">
            <div className="annotation">
                <a className="anchor" href="#section-1">&#x00a7;</a>
                Doctrine ORM features [a filter system](http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/filters.html) that allows the developer to add SQL to the conditional clauses of queries, regardless of the place where the SQL is generated (e.g. from a DQL query, or by loading associated entities).
These are applied on collections and items and therefore are incredibly useful.
The following information, specific to Doctrine filters in Symfony, is based upon [a great article posted on MichaÃ«l Perrin&#039;s blog](http://blog.michaelperrin.fr/2014/12/05/doctrine-filters/).
Suppose we have a `User` entity and an `Book` entity related to the `User` one. A user should only see his books and no one else&#039;s.
            </div>
            <div className="content">
                ```php
                // src/App/Entity.php
namespace App\Entity;
use ApiPlatform\Metadata\ApiResource;
use App\Attribute\UserAware;
use Doctrine\ORM\Mapping as ORM;

                ```
            </div>
        </div>
            <div className="section" id="section-2">
            <div className="annotation">
                <a className="anchor" href="#section-2">&#x00a7;</a>
                Create a User object to represent the current user.
            </div>
            <div className="content">
                ```php
                #[ApiResource]
#[ORM\Entity]
class User
{
    #[ORM\Id, ORM\Column, ORM\GeneratedValue]
    private ?int $id = null;
    #[ORM\Column]
    public ?string $username = null;
    public function getId(): ?int
    {
        return $this-&gt;id;
    }
}

                ```
            </div>
        </div>
            <div className="section" id="section-3">
            <div className="annotation">
                <a className="anchor" href="#section-3">&#x00a7;</a>
                Each Book is related to a User, supposedly allowed to authenticate.
            </div>
            <div className="content">
                ```php
                #[ApiResource]
#[ORM\Entity]

                ```
            </div>
        </div>
            <div className="section" id="section-4">
            <div className="annotation">
                <a className="anchor" href="#section-4">&#x00a7;</a>
                This entity is restricted by current user: only current user books will be shown (cf. UserFilter).
            </div>
            <div className="content">
                ```php
                #[UserAware(userFieldName: &#039;user_id&#039;)]
class Book
{
    #[ORM\Id, ORM\Column, ORM\GeneratedValue]
    private ?int $id = null;
    #[ORM\ManyToOne(User::class)]
    #[ORM\JoinColumn(name: &#039;user_id&#039;, referencedColumnName: &#039;id&#039;)]
    public User $user;
    #[ORM\Column]
    public ?string $title = null;
    public function getId(): ?int
    {
        return $this-&gt;id;
    }
}

// src/App/Attribute.php
namespace App\Attribute;
use Attribute;

                ```
            </div>
        </div>
            <div className="section" id="section-5">
            <div className="annotation">
                <a className="anchor" href="#section-5">&#x00a7;</a>
                The UserAware attribute restricts entities to the current user.
            </div>
            <div className="content">
                ```php
                #[Attribute(Attribute::TARGET_CLASS)]
final class UserAware
{
    public ?string $userFieldName = null;
}

// src/App/Filter.php
namespace App\Filter;
use App\Attribute\UserAware;
use Doctrine\ORM\Mapping\ClassMetadata;
use Doctrine\ORM\Query\Filter\SQLFilter;

                ```
            </div>
        </div>
            <div className="section" id="section-6">
            <div className="annotation">
                <a className="anchor" href="#section-6">&#x00a7;</a>
                The UserFilter adds a `AND user_id = :user_id` in the SQL query.
            </div>
            <div className="content">
                ```php
                final class UserFilter extends SQLFilter
{
    public function addFilterConstraint(ClassMetadata $targetEntity, $targetTableAlias): string
    {

                ```
            </div>
        </div>
            <div className="section" id="section-7">
            <div className="annotation">
                <a className="anchor" href="#section-7">&#x00a7;</a>
                The Doctrine filter is called for any query on any entity.
 Check if the current entity is &quot;user aware&quot; (marked with an attribute).
            </div>
            <div className="content">
                ```php
                        $userAware = $targetEntity-&gt;getReflectionClass()-&gt;getAttributes(UserAware::class)[0] ?? null;
        $fieldName = $userAware?-&gt;getArguments()[&#039;userFieldName&#039;] ?? null;
        if (&#039;&#039; === $fieldName || is_null($fieldName)) {
            return &#039;&#039;;
        }
        try {
            /*
             * Don&#039;t worry, getParameter automatically escapes parameters
             */
            $userId = $this-&gt;getParameter(&#039;id&#039;);
        } catch (\InvalidArgumentException $e) {
            /*
             * No user ID has been defined
             */
            return &#039;&#039;;
        }
        if (empty($fieldName) || empty($userId)) {
            return &#039;&#039;;
        }
        return sprintf(&#039;%s.%s = %s&#039;, $targetTableAlias, $fieldName, $userId);
    }
}

// src/App/EventSubscriber.php
namespace App\EventSubscriber;
use App\Entity\User;
use Doctrine\Persistence\ObjectManager;
use Symfony\Component\EventDispatcher\EventSubscriberInterface;
use Symfony\Component\HttpKernel\KernelEvents;

                ```
            </div>
        </div>
            <div className="section" id="section-8">
            <div className="annotation">
                <a className="anchor" href="#section-8">&#x00a7;</a>
                Retrieve the current user id and set it as SQL query parameter.
            </div>
            <div className="content">
                ```php
                final class UserAwareEventSubscriber implements EventSubscriberInterface
{
    public function __construct(private readonly ObjectManager $em)
    {
    }
    public static function getSubscribedEvents(): array
    {
        return [
            KernelEvents::REQUEST =&gt; &#039;onKernelRequest&#039;,
        ];
    }
    public function onKernelRequest(): void
    {
        /*
         * You should retrieve the current user using the TokenStorage service.
         * In this example, the user is forced by username to keep this guide simple.
         */
        $user = $this-&gt;em-&gt;getRepository(User::class)-&gt;findOneBy([&#039;username&#039; =&gt; &#039;jane.doe&#039;]);
        $filter = $this-&gt;em-&gt;getFilters()-&gt;enable(&#039;user_filter&#039;);
        $filter-&gt;setParameter(&#039;id&#039;, $user-&gt;getId());
    }
}

// src/App/DependencyInjection.php
 namespace App\DependencyInjection;
 use App\EventSubscriber\UserAwareEventSubscriber;
 use App\Filter\UserFilter;
 use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;
 use function Symfony\Component\DependencyInjection\Loader\Configurator\service;
 function configure(ContainerConfigurator $configurator) {
     $services = $configurator-&gt;services();
     $services-&gt;set(UserAwareEventSubscriber::class)
         -&gt;args([service(&#039;doctrine.orm.default_entity_manager&#039;)])
         -&gt;tag(&#039;kernel.event_subscriber&#039;)
     ;
     $configurator-&gt;extension(&#039;doctrine&#039;, [
         &#039;orm&#039; =&gt; [
             &#039;filters&#039; =&gt; [
                 &#039;user_filter&#039; =&gt; [
                     &#039;class&#039; =&gt; UserFilter::class,
                     &#039;enabled&#039; =&gt; true,
                 ],
             ],
         ],
     ]);
 }
// src/App/Playground.php
namespace App\Playground;
use Symfony\Component\HttpFoundation\Request;
function request(): Request
{
    return Request::create(&#039;/books.jsonld&#039;, &#039;GET&#039;);
}

// src/DoctrineMigrations.php
namespace DoctrineMigrations;
use Doctrine\DBAL\Schema\Schema;
use Doctrine\Migrations\AbstractMigration;
final class Migration extends AbstractMigration
{
    public function up(Schema $schema): void
    {
        $this-&gt;addSql(&#039;CREATE TABLE user (id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, username VARCHAR(255) NOT NULL)&#039;);
        $this-&gt;addSql(&#039;CREATE TABLE book (id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, title VARCHAR(255) NOT NULL, user_id INTEGER NOT NULL, FOREIGN KEY (user_id) REFERENCES user (id))&#039;);
    }
}

// src/App/Fixtures.php
namespace App\Fixtures;
use App\Entity\Book;
use App\Entity\User;
use Doctrine\Bundle\FixturesBundle\Fixture;
use Doctrine\Persistence\ObjectManager;
use Zenstruck\Foundry\AnonymousFactory;
final class BookFixtures extends Fixture
{
    public function load(ObjectManager $manager): void
    {
        $userFactory = AnonymousFactory::new(User::class);
        $johnDoe = $userFactory-&gt;create([&#039;username&#039; =&gt; &#039;john.doe&#039;]);
        $janeDoe = $userFactory-&gt;create([&#039;username&#039; =&gt; &#039;jane.doe&#039;]);
        $bookFactory = AnonymousFactory::new(Book::class);
        $bookFactory-&gt;many(10)-&gt;create([
            &#039;title&#039; =&gt; &#039;title&#039;,
            &#039;user&#039; =&gt; $johnDoe
        ]);
        $bookFactory-&gt;many(10)-&gt;create([
            &#039;title&#039; =&gt; &#039;title&#039;,
            &#039;user&#039; =&gt; $janeDoe
        ]);
    }
}

// src/App/Tests.php
namespace App\Tests;
use ApiPlatform\Symfony\Bundle\Test\ApiTestCase;
use App\Entity\Book;
use PhpDocumentGenerator\Playground\TestGuideTrait;
final class BookTest extends ApiTestCase
{
    use TestGuideTrait;
    public function testAsAnonymousICanAccessTheDocumentation(): void
    {
        $response = static::createClient()-&gt;request(&#039;GET&#039;, &#039;/books.jsonld&#039;);
        $this-&gt;assertResponseIsSuccessful();
        $this-&gt;assertMatchesResourceCollectionJsonSchema(Book::class, &#039;_api_/books{._format}_get_collection&#039;, &#039;jsonld&#039;);
        $this-&gt;assertNotSame(0, $response-&gt;toArray(false)[&#039;hydra:totalItems&#039;], &#039;The collection is empty.&#039;);
        $this-&gt;assertJsonContains([
            &#039;hydra:totalItems&#039; =&gt; 10,
        ]);
    }
}


                ```
            </div>
        </div>
    </div>
